apiVersion: apps/v1
kind: Deployment
metadata:
  name: faq-bot
  namespace: faq-bot
spec:
  replicas: 1  # Singleton for in-memory thread deduplication
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0  # Keep old pod running during updates
      maxSurge: 1
  selector:
    matchLabels:
      app: faq-bot
  template:
    metadata:
      labels:
        app: faq-bot
    spec:
      containers:
      - name: faq-bot
        image: devexslackbotacr.azurecr.io/faq-bot:v1.3.2
        imagePullPolicy: Always

        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"

        env:
        # Slack configuration
        - name: SLACK_BOT_TOKEN
          valueFrom:
            secretKeyRef:
              name: faq-bot-secrets
              key: slack-bot-token
        - name: SLACK_APP_TOKEN
          valueFrom:
            secretKeyRef:
              name: faq-bot-secrets
              key: slack-app-token
        - name: SLACK_ALLOWED_CHANNELS
          value: "C0A8JH4382G,C0ADGQVD48Y"

        # Claude API
        - name: ANTHROPIC_API_KEY
          valueFrom:
            secretKeyRef:
              name: faq-bot-secrets
              key: anthropic-api-key

        # FAQ source configuration
        - name: FAQ_SOURCE
          value: "notion"

        # Notion API key (recommended method)
        - name: NOTION_API_KEY
          valueFrom:
            secretKeyRef:
              name: faq-bot-secrets
              key: notion-api-key
        - name: NOTION_FAQ_PAGE_ID
          value: "2fc0839ee68480c3a0dfd7172035c589"

        # Legacy: Markdown file (not used when FAQ_SOURCE=notion)
        # - name: FAQ_FILE_PATH
        #   value: "/etc/faq/faq.md"

        # Retrieval settings (optional - these are defaults)
        - name: TOP_K
          value: "5"
        - name: MIN_SIMILARITY
          value: "0.70"
        - name: MIN_GAP
          value: "0.15"
        - name: MIN_RATIO
          value: "1.05"
        - name: FAQ_SYNC_INTERVAL
          value: "30"

        # Mode-specific ratio thresholds for confidence scoring
        - name: SEMANTIC_MIN_RATIO
          value: "1.10"
        - name: HYBRID_MIN_RATIO
          value: "1.02"
        - name: RERANKING_MIN_RATIO
          value: "1.003"

        # Hybrid Search (BM25 + Semantic)
        - name: HYBRID_SEARCH_ENABLED
          value: "true"
        - name: HYBRID_SEMANTIC_TOP_K
          value: "20"
        - name: HYBRID_BM25_TOP_K
          value: "20"

        # Cross-Encoder Reranking (enabled for best accuracy)
        - name: RERANKING_ENABLED
          value: "true"
        - name: RERANKING_MODEL
          value: "cross-encoder/ms-marco-MiniLM-L-6-v2"
        - name: RERANKING_RETRIEVAL_TOP_K
          value: "20"
        - name: RERANKING_TOP_K
          value: "5"

        # Proactive FAQ Suggestion Features
        - name: REACTION_SEARCH_ENABLED
          value: "true"
        - name: SLASH_COMMAND_ENABLED
          value: "true"
        - name: SUGGESTION_MIN_SIMILARITY
          value: "0.50"
        - name: SUGGESTION_TOP_K
          value: "5"

        # Status Update Monitoring
        - name: STATUS_MONITORING_ENABLED
          value: "true"
        - name: SLACK_STATUS_CHANNELS
          value: "C0A8JH4382G,C0ADGQVD48Y,C07R3UE2XV0"
        - name: STATUS_CACHE_TTL_HOURS
          value: "24"

        # Interaction Logging
        - name: INTERACTION_LOG_ENABLED
          value: "true"
        - name: INTERACTION_LOG_PATH
          value: "/tmp/interactions.db"

        # Read Receipts / Mention Tracking
        - name: MENTION_TRACKING_ENABLED
          value: "true"
        - name: RECEIPT_TTL_HOURS
          value: "168"

        # Admin Users (comma-separated Slack user IDs for admin-only commands)
        - name: SLACK_ADMIN_USER_IDS
          valueFrom:
            secretKeyRef:
              name: faq-bot-secrets
              key: slack-admin-user-ids

        # Mount FAQ content
        volumeMounts:
        - name: faq-content
          mountPath: /etc/faq
          readOnly: true

        # Health probes
        livenessProbe:
          exec:
            command:
            - python
            - -c
            - "import sys; sys.exit(0)"
          initialDelaySeconds: 60  # Allow time for model download + init
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          exec:
            command:
            - python
            - -c
            - "import sys; sys.exit(0)"
          initialDelaySeconds: 30
          periodSeconds: 10

      volumes:
      - name: faq-content
        configMap:
          name: faq-bot-config

      terminationGracePeriodSeconds: 30
